# 项目交接备忘录 | Project Handover Memo

**致接手的 AI 助手 / To the Next AI Assistant:**

本项目是一个高可靠性的 PowerPoint 翻译工具，经过多轮深度调试，解决了 `python-pptx` 处理复杂文档时的多个核心痛点。

---

### ✅ 已完成的核心工作 (Core Progress)

1. **递归文本提取 (Recursive Extraction)**:
   - 实现了对 `MSO_SHAPE_TYPE.GROUP` (组合形状) 的深度优先遍历。
   - **价值**: 确保了隐藏在复杂图表、组合框中的文字能够被 100% 提取，不再遗漏。

2. **Slide 级批处理 + ID 锚点 (Batching & ID Anchoring)**:
   - **策略**: 将单页 PPT 的所有文本 Runs 序列化为带有 ID 的 JSON 数组。
   - **Prompt**: 引导 LLM 在保留标签 (如 `<r0>`) 的同时返回标准 JSON。
   - **价值**: 彻底解决了翻译结果与原文位置错位、数量不匹配导致的“回填失败”问题。

3. **格式保留策略 (Format Preservation)**:
   - 成功保留了字体级别的 **加粗 (Bold)**、*斜体 (Italic)* 和 **RGB 颜色**。

4. **稳定性防御 (Stability Strategy) - 关键教训**:
   - **发现**: 修改 `width`, `height`, `left`, `top` 或 `line_spacing` 极易触发 PowerPoint 的“文件损坏”或“需要修复”错误。
   - **处理**: 代码中已主动禁用这些属性的写入。目前的策略是：**只换文字，不改容器尺寸**。

---

### 📂 项目关键结构 (Project Structure)

- `scripts/ppt_translator/pipeline.py`: 核心流程。包含递归 `process_shape` 逻辑和 `deferred_writes` (延迟写入机制)。
- `scripts/ppt_translator/translation.py`: 翻译调度。包含 JSON 批处理逻辑和重试机制。
- `scripts/change_color.py`: 独立的全局颜色修改工具。

---

### ⚠️ 核心警示 (Critical Warnings)

- **禁止恢复 `line_spacing` 写入**: 测试证明 `python-pptx` 在处理某些行间距 XML (`spcPct`) 时有 Bug，会导致 `InvalidXmlError` 并使 PPT 崩溃。
- **几何属性锁定**: 永远不要尝试在 `apply_shape_properties` 中强制还原坐标和大小。
- **字符清洗**: 必须保留 `remove_control_characters` 函数，否则 LLM 返回的某些控制字符会导致 XML 解析失败。

---

### 🚀 后续开发建议 (Next Steps)

1. **字体自动缩放 (Auto-scaling)**: 当前使用固定的 `font_scale=0.7`。可以改进为根据翻译前后字符长度比例动态调整缩放。
2. **合并单元格处理**: 目前表格处理针对标准单元格，复杂合并单元格的边界情况可能需要进一步测试。
3. **GUI 封装**: 可以考虑增加一个简单的拖拽式界面。

---
*Generated by Gemini CLI Agent*
